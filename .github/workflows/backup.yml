name: Backup Concept2 Activities

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Download mode'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - single
      result_id:
        description: 'Result ID (only needed for single mode)'
        required: false
        type: string

  repository_dispatch:
    types: [c2_new_activity]

jobs:
  backup:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # 1. Checkout 代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 安装 uv (这一步会自动处理 Python 环境，速度极快)
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "scripts/uv.lock"

      # 3. 设置 Python 并安装依赖
      - name: Set up Python & Install dependencies
        working-directory: scripts
        run: |
          # 指定 Python 版本并同步依赖
          uv python install 3.13
          uv sync --all-extras --dev

      # 4. 配置环境变量
      - name: Configure environment
        env:
          C2_ACCESS_TOKEN: ${{ secrets.C2_ACCESS_TOKEN }}
        run: |
          echo "C2_ACCESS_TOKEN=${C2_ACCESS_TOKEN}" >> $GITHUB_ENV

      # 5. 验证 Token
      - name: Validate Concept2 Access Token
        working-directory: scripts
        run: uv run simple_auth.py

      # 6. 下载数据 (根据触发类型)
      - name: Download single activity (repository dispatch)
        if: github.event_name == 'repository_dispatch'
        working-directory: scripts
        run: |
          RESULT_ID=${{ github.event.client_payload.result_id }}
          echo "Downloading activity with result_id: $RESULT_ID"
          uv run download_single.py $RESULT_ID

      - name: Download single activity (manual trigger)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'single' && github.event.inputs.result_id != ''
        working-directory: scripts
        run: |
          RESULT_ID=${{ github.event.inputs.result_id }}
          echo "Downloading activity with result_id: $RESULT_ID"
          uv run download_single.py $RESULT_ID

      - name: Download full history (manual trigger)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'full'
        working-directory: scripts
        run: |
          echo "Downloading full workout history..."
          uv run download_history.py

      # 7. 生成热力图 (Generate Heatmap)
      - name: Generate Activity Heatmap
        working-directory: scripts
        run: |
          # 只要你的 uv.lock 里包含了 july 和 matplotlib，直接 run 即可
          # 如果不想依赖 lock 文件，也可以用临时命令: uv run --with july --with matplotlib update_heatmap.py
          uv run update_heatmap.py

      # 8. 检测变更 (包含 .tcx, .png, .json)
      - name: Check for changes
        id: check_changes
        run: |
          git add -f data/
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No new activities or heatmap updates to commit."
          fi

      # 9. 配置 Git
      - name: Configure git
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "c2-bot@users.noreply.github.com"
          git config --local user.name "C2-Bot"

      # 10. 提交变更
      - name: Commit changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            RESULT_ID=${{ github.event.client_payload.result_id }}
            git commit -m "Add activity ${RESULT_ID} & Update heatmap [skip ci]"
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.mode }}" == "single" ]; then
              RESULT_ID=${{ github.event.inputs.result_id }}
              git commit -m "Add activity ${RESULT_ID} & Update heatmap [skip ci]"
            else
              git commit -m "Update activity history & heatmap [skip ci]"
            fi
          fi

      # 11. 推送
      - name: Push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      # 12. 摘要 Summary
      - name: Summary
        run: |
          echo "## Backup Summary" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "**Status:** ✅ Updated successfully" >> $GITHUB_STEP_SUMMARY
            # 显示生成的图片预览
            echo "![Heatmap](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/data/profile-heatmap.png?raw=true)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ℹ️ No changes" >> $GITHUB_STEP_SUMMARY
          fi